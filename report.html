<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - Income Expense Management</title>
    <script src="script.js" defer></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- pdf -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Make sure to include SheetJS -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .logo h1 {
            font-size: 1.4rem;
            font-weight: 600;
        }

        .nav-menu {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .nav-btn.active {
            background: white;
            color: #667eea;
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 25px;
        }

        /* Section */
        .section {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #2d3436;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .section-title i {
            color: #667eea;
            font-size: 22px;
        }

        /* Filter Section */
        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }

        .filter-btn {
            padding: 10px 18px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            background: white;
            color: #636e72;
        }

        .filter-btn:hover,
        .filter-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .custom-date {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
        }

        .custom-date input {
            border: none;
            padding: 5px;
            font-size: 13px;
            width: 130px;
        }

        .custom-date input:focus {
            outline: none;
        }

        .btn-ok {
            padding: 8px 15px;
            background: linear-gradient(135deg, #00b894, #00cec9);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-ok:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 184, 148, 0.4);
        }

        .divider {
            width: 2px;
            height: 35px;
            background: #e0e0e0;
            margin: 0 10px;
        }

        .btn-backup {
            padding: 10px 18px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            color: white;
        }

        .btn-backup.pdf {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .btn-backup.excel {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }

        .btn-backup:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
        }

        /* Charts Section */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 0.5fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            /* softer shadow */
            transition: all 0.3s ease;
        }

        .chart-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.10);
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: #2d3436;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-title i {
            color: #667eea;
        }

        .chart-container {
            position: relative;
            height: 250px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .chart-container.bar {
            height: 280px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Grid Table */
        .grid-container {
            max-height: 420px;
            overflow-y: auto;
            border-radius: 12px;
            border: 1px solid #ddd;
        }

        .grid-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            background: white;
        }

        .grid-table thead th {
            position: sticky;
            top: 0;
            background: #667eea;
            color: white;
            z-index: 50;
            font-size: 14px;
            padding: 12px;
        }

        .grid-table td {
            padding: 12px;
            font-size: 13px;
            border-bottom: 1px solid #eee;
        }

        .grid-table tbody tr:hover {
            background: #dce3f7;
        }

        /*Fixed header */

        .grid-table thead th {
            position: sticky;
            top: 0;
            background-color: #667eea, #764ba2;
            z-index: 100;
            /* So it stays above table rows */
        }


        /* Income / Expense Badge in Table */
        .badge-income {
            background: green;
            /* increased opacity */
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
        }

        .badge-expense {
            background: red;
            /* increased opacity */
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
        }

        .income-other,
        .expense-type,
        .remark {
            max-width: 120px;
            white-space: normal;
            word-wrap: break-word;
        }

        /* Amount colors */
        .amount-income {
            color: green;
            font-weight: 700;
            font-size: 14px;
        }

        .amount-expense {
            color: red;
            font-weight: 700;
            font-size: 14px;
        }

        /* Balance colors for summary */
        .balance-positive {
            color: green;
            font-weight: 600;
        }

        .balance-negative {
            color: red;
            font-weight: 600;
        }

        /* Income / Expense Badge in Table end */

        /* Summary Stats */
        .summary-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }

        .stat-icon {
            width: 55px;
            height: 55px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .stat-card.income .stat-icon {
            background: rgba(0, 184, 148, 0.15);
            color: #00b894;
        }

        .stat-card.expense .stat-icon {
            background: rgba(231, 76, 60, 0.15);
            color: #e74c3c;
        }

        .stat-card.balance .stat-icon {
            background: rgba(102, 126, 234, 0.15);
            color: #667eea;
        }

        .stat-info {
            flex: 1;
        }

        .stat-label {
            font-size: 13px;
            color: #7f8c8d;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
        }

        .stat-card.income .stat-value {
            color: #00b894;
        }

        .stat-card.expense .stat-value {
            color: #e74c3c;
        }

        .stat-card.balance .stat-value {
            color: #667eea;
        }

        /* Footer */
        .footer {
            background: linear-gradient(135deg, #2d3436, #636e72);
            padding: 20px;
            text-align: center;
            color: white;
            margin-top: 20px;
        }

        .footer p:first-child {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .footer p:last-child {
            font-size: 13px;
            opacity: 0.8;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .summary-row {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                gap: 15px;
            }

            .filter-row {
                flex-direction: column;
                align-items: stretch;
            }

            .divider {
                display: none;
            }
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <div class="logo-icon">
                <i class="fas fa-wallet"></i>
            </div>
            <h1>Income Expense Management System</h1>
        </div>
        <nav class="nav-menu">
            <button class="nav-btn" onclick="window.location.href='index.html'">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </button>
            <button class="nav-btn">
                <a href="report.html" target="_blank" class="nav-btn">
                    <i class="fas fa-chart-bar"></i> Reports</a>
            </button>
            <button class="nav-btn">
                <a href="Edit.html" target="_blank" class="nav-btn">
                <i class="fas fa-cog"></i> Edit/Delete</a>
            </button>
        </nav>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Summary Stats -->
        <div class="summary-row">
            <div class="stat-card income">
                <div class="stat-icon">
                    <i class="fas fa-arrow-down"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-label">Total Income</div>
                    <div class="stat-value">₹ </div>
                </div>
            </div>
            <div class="stat-card expense">
                <div class="stat-icon">
                    <i class="fas fa-arrow-up"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-label">Total Expense</div>
                    <div class="stat-value">₹ </div>
                </div>
            </div>
            <div class="stat-card balance">
                <div class="stat-icon">
                    <i class="fas fa-balance-scale"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-label">Net Balance</div>
                    <div class="stat-value">₹ </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-grid">
            <!-- Pie Chart -->
            <div class="chart-card">
                <div class="chart-title">
                    <i class="fas fa-chart-pie"></i>
                    Income vs Expense Distribution
                </div>
                <div class="chart-container">
                    <canvas id="pieChart"></canvas>
                </div>
            </div>

            <!-- Bar Chart -->
            <div class="chart-card">
                <div class="chart-title">
                    <i class="fas fa-chart-bar"></i>
                    Income Type Analysis
                </div>
                <div class="chart-container bar">
                    <canvas id="barChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Transactions Report Section -->
        <div class="section">
            <h2 class="section-title">
                <i class="fas fa-file-invoice-dollar"></i> Transactions Report
            </h2>
            <div class="filter-row">
                <button class="filter-btn" onclick="filterTransactions(this, 'today')">
                    <i class="fas fa-calendar-day"></i> Today
                </button>
                <button class="filter-btn" onclick="filterTransactions(this, 'yesterday')">
                    <i class="fas fa-calendar-minus"></i> Yesterday
                </button>
                <button class="filter-btn" onclick="filterTransactions(this, 'week')">
                    <i class="fas fa-calendar-week"></i> Last 7 Days
                </button>
                <button class="filter-btn" onclick="filterTransactions(this, 'month')">
                    <i class="fas fa-calendar-alt"></i> Last 30 Days
                </button>
                <div class="custom-date">
                    <i class="fas fa-calendar-range" style="color: #667eea;"></i>
                    <input type="date" id="startDate" placeholder="Start Date">
                    <span>to</span>
                    <input type="date" id="endDate" placeholder="End Date">
                    <button class="btn-ok" onclick="applyCustomDate()">
                        <i class="fas fa-check"></i> OK
                    </button>
                </div>
                <div class="divider"></div>
                <button class="btn-backup pdf" onclick="downloadPDF()">
                    <i class="fas fa-file-pdf"></i> Backup PDF
                </button>
                <button class="btn-backup excel" onclick="downloadExcel()">
                    <i class="fas fa-file-excel"></i> Backup Excel
                </button>
            </div>

            <!-- Transactions Table -->


            <div class="grid-container">
                <table class="grid-table">
                    <thead>
                        <tr>
                            <th><i class="fas fa-hashtag"></i> ID</th>
                            <th><i class="fas fa-calendar"></i> Date</th>
                            <th> Transaction Type</th>
                            <th><i class="fas fa-exchange-alt"></i> Income Type</th>
                            <th><i class="fas fa-info-circle"></i> Income Other</th>
                            <th><i class="fas fa-receipt"></i> Expense Type</th>
                            <th><i class="fas fa-rupee-sign"></i> Amount</th>
                            <th><i class="fas fa-comment"></i> Remark</th>
                            <th> Payment_Mode</th>
                            <th><i class="fas fa-info-circle"></i> Check_NO</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>


        </div>

        <!-- Footer -->
        <footer class="footer">
            <p>© 2025 Income Expense Manager</p>
            <p>Manage your finances with confidence.</p>
        </footer>

        <script>


            // Filter Transactions
            function filterTransactions(btn, filter) {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                console.log('Filtering by:', filter);
                // Add your filtering logic here
            }
            // pdf backup
            function downloadPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // ---------------- CURRENT DATE + TIME --------------------
                const now = new Date();
                const date = now.toLocaleDateString("en-IN");
                const time = now.toLocaleTimeString("en-IN", {
                    hour: "2-digit",
                    minute: "2-digit",
                    hour12: true
                });
                const dateTimeText = `Generated on: ${date} | ${time}`;

                // ---------------- TITLE + FILTER NAME --------------------
                let activeBtn = document.querySelector(".filter-btn.active");
                let customFilterText = document.getElementById("filterInfoText"); // hidden element for custom date
                let filterText = "All";
                if (activeBtn) filterText = activeBtn.innerText.trim().replace(/\s+/g, " ");
                else if (customFilterText && customFilterText.innerText.trim() !== "") filterText = customFilterText.innerText.trim();

                doc.setFontSize(16);
                doc.text(`Transactions Report (${filterText})`, doc.internal.pageSize.getWidth() / 2, 15, { align: "center" });

                // ---- ADD DATE + TIME BELOW THE TITLE ----
                doc.setFontSize(11);
                doc.setTextColor(80, 80, 80);
                doc.text(dateTimeText, doc.internal.pageSize.getWidth() / 2, 22, { align: "center" });
                doc.setTextColor(0, 0, 0);

                // ---------------- SUMMARY VALUES --------------------
                const income = document.querySelector(".stat-card.income .stat-value").innerText.replace(/[₹,\s]/g, "");
                const expense = document.querySelector(".stat-card.expense .stat-value").innerText.replace(/[₹,\s]/g, "");
                const balance = document.querySelector(".stat-card.balance .stat-value").innerText.replace(/[₹,\s]/g, "");

                doc.setFontSize(12);
                doc.setTextColor(0, 128, 0);
                doc.text(`Total Income: ${Number(income).toLocaleString("en-IN")}`, 14, 32);
                doc.setTextColor(255, 0, 0);
                doc.text(`Total Expense: ${Number(expense).toLocaleString("en-IN")}`, 80, 32);
                doc.setTextColor(0, 0, 255);
                doc.text(`Net Balance: ${Number(balance).toLocaleString("en-IN")}`, 150, 32);
                doc.setTextColor(0, 0, 0);

                // ---------------- TABLE HEADERS --------------------
                const headers = ["ID", "Date", "Transaction", "IncomeType", "IncomeOth.", "ExpenseType", "Amount", "Remark", "PaymentMode", "CheckNo"];

                // ---------------- ROW EXTRACTION --------------------
                const table = document.getElementById("tableBody");
                const rows = [];
                table.querySelectorAll("tr").forEach(tr => {
                    const tds = tr.querySelectorAll("td");
                    rows.push([
                        tds[0].innerText,
                        tds[1].innerText,
                        tds[2].innerText,
                        tds[3].innerText,
                        tds[4].innerText,
                        tds[5].innerText,
                        (() => {
                            let clean = tds[6].innerText.replace(/[₹,\s]/g, "");
                            if (clean === "" || isNaN(clean)) clean = "0";
                            return Number(clean).toLocaleString("en-IN");
                        })(),
                        tds[7].innerText,
                        tds[8].innerText,
                        tds[9].innerText
                    ]);
                });

                // ---------------- TABLE GENERATION --------------------
                doc.autoTable({
                    head: [headers],
                    body: rows,
                    startY: 40,
                    styles: { fontSize: 9, cellPadding: 2 },
                    headStyles: { fillColor: [40, 120, 200], textColor: [255, 255, 255], halign: "left" },
                    columnStyles: { 6: { halign: "right" }, 7: { halign: "right" }, 8: { halign: "right" }, 9: { halign: "right" } },
                    didParseCell: function (data) {
                        if (data.section === "body") {
                            const type = data.row.raw[2].toLowerCase();
                            if (type === "income") {
                                data.row.cells[2].styles.textColor = [0, 128, 0];
                                data.row.cells[6].styles.textColor = [0, 128, 0];
                            }
                            if (type === "expense") {
                                data.row.cells[2].styles.textColor = [255, 0, 0];
                                data.row.cells[6].styles.textColor = [255, 0, 0];
                            }
                        }
                    }
                });

                // ---------------- INSERT CHARTS ON SAME PAGE --------------------
                let chartsStartY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 10 : 50;
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const chartHeight = 80;
                const chartWidth = (pageWidth - 40) / 2; // Two charts side by side with margin

                // Pie Chart
                const pieCanvas = document.getElementById("pieChart");
                if (pieCanvas) {
                    const pieImg = pieCanvas.toDataURL("image/png", 1.0);
                    doc.addImage(pieImg, 'PNG', 15, chartsStartY, chartWidth, chartHeight);
                    doc.setFontSize(12);
                    doc.text("Income vs Expense", 15 + chartWidth / 2, chartsStartY + chartHeight + 5, { align: "center" });
                }

                // Bar Chart
                const barCanvas = document.getElementById("barChart");
                if (barCanvas) {
                    const barImg = barCanvas.toDataURL("image/png", 1.0);
                    doc.addImage(barImg, 'PNG', 25 + chartWidth, chartsStartY, chartWidth, chartHeight);
                    doc.setFontSize(12);
                    doc.text("Income by Type", 25 + chartWidth + chartWidth / 2, chartsStartY + chartHeight + 5, { align: "center" });
                }

                doc.save("Transactions_Report.pdf");
            }


            //excel backup
            function downloadExcel() {
                const table = document.getElementById("tableBody");
                const rows = [];

                // Summary
                const totalIncome = document.querySelector(".stat-card.income .stat-value").innerText;
                const totalExpense = document.querySelector(".stat-card.expense .stat-value").innerText;
                const netBalance = document.querySelector(".stat-card.balance .stat-value").innerText;

                // Filter info
                const activeBtn = document.querySelector(".filter-btn.active");
                let filterText = activeBtn ? activeBtn.innerText : "Custom";
                const startDate = document.getElementById("startDate").value;
                const endDate = document.getElementById("endDate").value;
                let dateInfo = (filterText.toLowerCase() === "custom" && startDate && endDate) ?
                    `Date Range: ${startDate} to ${endDate}` : `Filter: ${filterText}`;

                // Add summary and filter as first rows
                rows.push(["Transactions Report"]);
                rows.push([dateInfo]);
                rows.push([`Total Income: ${totalIncome}`, `Total Expense: ${totalExpense}`, `Net Balance: ${netBalance}`]);
                rows.push([]); // empty row

                // Table headers
                const headers = ["ID", "Date", "Transaction Type", "Income Type", "Income Other", "Expense Type", "Amount", "Remark", "Payment Mode", "Check No"];
                rows.push(headers);

                // Table data
                table.querySelectorAll("tr").forEach(tr => {
                    const row = [];
                    tr.querySelectorAll("td").forEach(td => row.push(td.innerText));
                    rows.push(row);
                });

                // Create worksheet and workbook
                const ws = XLSX.utils.aoa_to_sheet(rows);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Transactions");

                // Export
                XLSX.writeFile(wb, "Transactions_Report.xlsx");
            }
            // ===================================================================
            //const scriptURL = "https://script.google.com/macros/s/AKfycbzIBaeKH7g1IKFukV3BkuMsDkPNImlvbCuZm_-tHKkWPZcEP4uNXvs9sE2SU3ej8zOi/exec";
           // main url anyone 
                const scriptURL = "https://script.google.com/macros/s/AKfycbzIBaeKH7g1IKFukV3BkuMsDkPNImlvbCuZm_-tHKkWPZcEP4uNXvs9sE2SU3ej8zOi/exec";
            // only for me 
            //const scriptURL="https://script.google.com/macros/s/AKfycbwj4Lupx0ud_eGHs0NSQUE-xnufIthvOUPct7WI7SAiIYbhKIYeJ8ML9R7ueDYtQnCz/exec";


            let allData = []; // global store
            let pieChartInstance, barChartInstance;

            // Fetch data from Google Sheet but DO NOT show table on load
            window.addEventListener('DOMContentLoaded', () => {
                fetch(scriptURL)
                    .then(res => res.json())
                    .then(data => {
                        console.log("RAW DATA FROM SHEET:", data);
                        allData = data; // store globally
                        // automatically show Today’s data
                        const todayButton = document.querySelector('.filter-btn[data-period="today"]');
                        if (todayButton) filterTransactions(todayButton, 'today');
                    });

            });

            // ------------------- Display Table -------------------
            function displayData(data) {
                const tbody = document.getElementById("tableBody");
                tbody.innerHTML = "";

                // Sort by date descending
                data.sort((a, b) => new Date(b.Date) - new Date(a.Date));

                data.forEach(row => {
                    const amount = Number(row.Amount) || 0;
                    const type = (row.Transaction_Type || "").toLowerCase();

                    const amountClass = type === "income" ? "amount-income" : type === "expense" ? "amount-expense" : "";
                    const badge = type === "income" ? `<span class="badge-income">Income</span>` :
                        type === "expense" ? `<span class="badge-expense">Expense</span>` : row.Transaction_Type;

                    tbody.innerHTML += `
            <tr>
                <td>${row.id}</td>
                <td>${formatDate(row.Date)}</td>
                <td>${badge}</td>
                <td>${row.Income_Type || ""}</td>
                <td class="income-other">${row.Income_Other || "-"}</td>
                <td class="expense-type">${row.Expense_Type || "-"}</td>
                <td class="${amountClass}">${formatAmount(amount)}</td>
                <td class="remark">${row.Remark || "-"}</td>
                <td>${row.Payment_Mode || "-"}</td>
                <td>${row.Check_NO || "-"}</td>
            </tr>
        `;
                });

                // Update summary and charts AFTER all rows are added
                updateSummary(data);
                updateCharts(data);
            }

            // ------------------- Format Helpers -------------------
            function formatAmount(amount) {
                if (!amount || isNaN(amount)) return "-";
                return `₹ ${Number(amount).toLocaleString("en-IN")}`;
            }

            function formatDate(dateString) {
                if (!dateString) return "";
                const date = new Date(dateString);
                const day = String(date.getDate()).padStart(2, "0");
                const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                const month = monthNames[date.getMonth()];
                const year = date.getFullYear();
                return `${day}-${month}-${year}`;
            }

            // ------------------- Date Helpers -------------------
            function isSameDay(d1, d2) {
                return d1.getFullYear() === d2.getFullYear() &&
                    d1.getMonth() === d2.getMonth() &&
                    d1.getDate() === d2.getDate();
            }
            function startOfDay(date) {
                const d = new Date(date); d.setHours(0, 0, 0, 0); return d;
            }
            function endOfDay(date) {
                const d = new Date(date); d.setHours(23, 59, 59, 999); return d;
            }

            // ------------------- Filter Functions -------------------
            function filterTransactions(button, period) {
                period = period.toLowerCase(); // force lowercase
                if (!allData.length) return alert("Data not loaded yet!");

                // Highlight active button
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                if (button) button.classList.add('active');

                const today = new Date();
                let filteredData = [];

                switch (period) {
                    case 'today':
                        filteredData = allData.filter(row => isSameDay(new Date(row.Date), today));
                        break;
                    case 'yesterday':
                        const yesterday = new Date(today); yesterday.setDate(today.getDate() - 1);
                        filteredData = allData.filter(row => isSameDay(new Date(row.Date), yesterday));
                        break;
                    case 'week':
                        const weekAgo = new Date(today); weekAgo.setDate(today.getDate() - 6);
                        filteredData = allData.filter(row => {
                            const d = new Date(row.Date);
                            return d >= startOfDay(weekAgo) && d <= endOfDay(today);
                        });
                        break;
                    case 'month':
                        const monthAgo = new Date(today); monthAgo.setDate(today.getDate() - 29);
                        filteredData = allData.filter(row => {
                            const d = new Date(row.Date);
                            return d >= startOfDay(monthAgo) && d <= endOfDay(today);
                        });
                        break;
                }

                displayData(filteredData);
            }

            function applyCustomDate() {
                const start = new Date(document.getElementById('startDate').value);
                const end = new Date(document.getElementById('endDate').value);

                if (!start || !end) return alert("Select both start and end dates");

                const filteredData = allData.filter(row => {
                    const d = new Date(row.Date);
                    return d >= startOfDay(start) && d <= endOfDay(end);
                });

                displayData(filteredData);

                // remove active class from buttons
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));

                // ---------------- SAVE CUSTOM DATE TEXT FOR PDF ----------------
                const sd = document.getElementById('startDate').value;
                const ed = document.getElementById('endDate').value;

                let f = document.getElementById("filterInfoText");
                if (!f) {
                    f = document.createElement("span");
                    f.id = "filterInfoText";
                    f.style.display = "none";     // hide in UI
                    document.body.appendChild(f);
                }

                f.innerText = `${sd} to ${ed}`;
            }


            // ------------------- Summary Cards -------------------
            function updateSummary(data) {
                let totalIncome = 0, totalExpense = 0;
                data.forEach(row => {
                    const type = (row.Transaction_Type || "").toLowerCase();
                    const amount = Number(row.Amount) || 0;
                    if (type === "income") totalIncome += amount;
                    else if (type === "expense") totalExpense += amount;
                });

                document.querySelector('.stat-card.income .stat-value').innerText = formatAmount(totalIncome);
                document.querySelector('.stat-card.expense .stat-value').innerText = formatAmount(totalExpense);
                document.querySelector('.stat-card.balance .stat-value').innerText = formatAmount(totalIncome - totalExpense);
            }

            // ------------------- Charts -------------------
            function updateCharts(data) {
                // Pie Chart
                const totalIncome = data.reduce((sum, row) => row.Transaction_Type.toLowerCase() === 'income' ? sum + Number(row.Amount) : sum, 0);
                const totalExpense = data.reduce((sum, row) => row.Transaction_Type.toLowerCase() === 'expense' ? sum + Number(row.Amount) : sum, 0);

                const pieCtx = document.getElementById('pieChart').getContext('2d');
                if (pieChartInstance) pieChartInstance.destroy();
                pieChartInstance = new Chart(pieCtx, {
                    type: 'pie',
                    data: {
                        labels: ['Income', 'Expense'],
                        datasets: [{
                            data: [totalIncome, totalExpense],
                            backgroundColor: ['#0cec7c', '#e74c3c']
                        }]
                    },
                    options: {
                        responsive: true
                    }
                });


                // Bar Chart - Income Type
                const incomeData = {};
                data.forEach(row => {
                    if ((row.Transaction_Type || "").toLowerCase() === 'income') {
                        const type = row.Income_Type || 'Other';
                        incomeData[type] = (incomeData[type] || 0) + Number(row.Amount);
                    }
                });

                // Generate random pleasant colors for each bar
                const colors = Object.keys(incomeData).map(() =>
                    `hsl(${Math.floor(Math.random() * 360)}, 70%, 55%)`
                );

                const barCtx = document.getElementById('barChart').getContext('2d');
                if (barChartInstance) barChartInstance.destroy();

                barChartInstance = new Chart(barCtx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(incomeData),
                        datasets: [{
                            label: 'Income by Type',
                            data: Object.values(incomeData),
                            backgroundColor: colors,
                            borderColor: '#333',
                            borderWidth: 1,
                            borderRadius: 6,   // optional: slightly rounded bars
                            barThickness: 60   // thinner bars
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: true,
                                labels: {
                                    filter: function (item) { return item.text !== 'Other'; } // hide 'Other' in legend if needed
                                }
                            }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }

        </script>
</body>

</html>